### ğŸ§© ä¸€ã€ä»€ä¹ˆæ˜¯ ReadableStreamï¼Ÿ

1. ReadableStream æ˜¯ Web Streams API çš„æ ¸å¿ƒç±»å‹ä¹‹ä¸€ï¼Œç”¨äºè¡¨ç¤ºå¯è¯»çš„æ•°æ®æµã€‚å®ƒå®šä¹‰äº†ä»¥ä¸‹ä¸»è¦æ–¹æ³•å’Œå±æ€§ï¼š
> âœ… ä»â€œæ•°æ®æºâ€è¯»å–ä¸€æ®µä¸€æ®µçš„æ•°æ®ï¼ˆchunkï¼‰â€”â€”ä¾‹å¦‚ï¼šå“åº”ä½“ã€è§†é¢‘æµã€æ–‡ä»¶æµç­‰ã€‚
>

### ğŸ§© äºŒã€ReadableStream çš„å¸¸ç”¨æ–¹æ³•å’Œå±æ€§

| åˆ†ç±»    | åç§°              | è¯´æ˜         |
| ----- | --------------- | ---------- |
| å±æ€§    | `locked`        | æ˜¯å¦å·²è¢«è¯»å–å™¨é”å®š  |
| æ–¹æ³•    | `getReader()`   | è·å–è¯»å–å™¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ |
| æ–¹æ³•    | `tee()`         | å…‹éš†ä¸ºä¸¤ä¸ªæµ     |
| æ–¹æ³•    | `cancel()`      | ä¸»åŠ¨å–æ¶ˆæµ      |
| è¯»å–å™¨æ–¹æ³• | `read()`        | è¯»å–ä¸‹ä¸€å—æ•°æ®    |
| è¯»å–å™¨æ–¹æ³• | `releaseLock()` | è§£é”         |
| æ§åˆ¶å™¨   | `enqueue()`     | æ¨é€æ•°æ®å—      |
| æ§åˆ¶å™¨   | `close()`       | å…³é—­æµ        |
| æ§åˆ¶å™¨   | `error()`       | æŠ›å‡ºé”™è¯¯       |


### ğŸ§© ä¸‰ã€ReadableStream çš„æ ¸å¿ƒç»“æ„
```js
const stream = new ReadableStream({
  start(controller) {},
  pull(controller) {},
  cancel(reason) {}
});
```

### âœ… å››ã€ReadableStream çš„ æ–¹æ³•

#### 1. `getReader()`
1. ç”¨äºè·å–ä¸€ä¸ªè¯»å–å™¨æ¥è¯»å–è¿™ä¸ªæµçš„å†…å®¹ã€‚
2. è¿”å› ReadableStreamDefaultReader å¯¹è±¡ï¼ˆæœ€å¸¸ç”¨çš„è¯»å–æ–¹å¼ï¼‰
3. é€šè¿‡ .getReader() è·å¾—çš„ Reader çš„æ–¹æ³•
| æ–¹æ³•               | è¿”å›ç±»å‹    | è¯´æ˜                          |
| ---------------- | ------- | --------------------------- |
| `read()`         | Promise | è¯»å–ä¸€æ®µæ•°æ®ï¼Œè¿”å› `{ done, value }` |
| `releaseLock()`  | void    | é‡Šæ”¾å¯¹è¯¥æµçš„é”ï¼ˆå…è®¸å†æ¬¡ getReaderï¼‰     |
| `cancel(reason)` | Promise | å–æ¶ˆè¯»å–å™¨ï¼Œé‡Šæ”¾èµ„æº                  |



#### 2. `tee()` 
1. å…‹éš†ä¸ºä¸¤ä¸ªæµ
2. è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæµçš„æ•°ç»„
3. `const [stream1, stream2] = stream.tee();`
   
#### 3. `cancel()`  

1. ä¸»åŠ¨å–æ¶ˆæµ
2. å‚æ•°ï¼šreason å–æ¶ˆçš„åŸå› 
3. `stream.cancel('ç”¨æˆ·å–æ¶ˆäº†');`

#### 4. `read()`
1. è¯»å–ä¸‹ä¸€å—æ•°æ®
2. è¿”å›ä¸€ä¸ªåŒ…å« done å’Œ value çš„ Promise
3. `const { done, value } = await reader.read();`


#### 5. `releaseLock()`
1. è§£é”
2. åœ¨è¯»å–å™¨è¯»å–å®Œæ•°æ®åè°ƒç”¨
3. `reader.releaseLock();`  


### âœ… äº”ã€ReadableStream çš„è¡Œä¸ºï¼ˆç±»ä¼¼äº‹ä»¶ï¼‰
1. ReadableStream å¹¶ä¸ä½¿ç”¨ä¼ ç»Ÿçš„ .on('data') äº‹ä»¶æœºåˆ¶ï¼Œè€Œæ˜¯ä½¿ç”¨ pull æ¨¡å¼ + Promise ç»„åˆï¼Œä½ é€šè¿‡ reader.read() æ‰‹åŠ¨æ‹‰å–æ•°æ®ã€‚ä½†å®ƒå†…éƒ¨è¡Œä¸ºå¯ç”±æ„é€ å‡½æ•°çš„é…ç½®æ§åˆ¶ï¼š

```js
new ReadableStream({
  start(controller) {
    // æµå¼€å§‹æ—¶è°ƒç”¨
  },
  pull(controller) {
    // å½“æ¶ˆè´¹æ–¹å‡†å¤‡å¥½æ¥æ”¶æ›´å¤šæ•°æ®æ—¶è°ƒç”¨
  },
  cancel(reason) {
    // æ¶ˆè´¹æ–¹è°ƒç”¨ stream.cancel() æ—¶è§¦å‘
  }
});


```



### âœ… å…­ã€å®Œæ•´æ¡ˆä¾‹ï¼šåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æµ
```js
const stream = new ReadableStream({
  start(controller) {
    controller.enqueue(new TextEncoder().encode("Hello, "));
    controller.enqueue(new TextEncoder().encode("stream!"));
    controller.close();
  }
});

const reader = stream.getReader();
reader.read().then(console.log); // { value: Uint8Array(7), done: false }
reader.read().then(console.log); // { value: Uint8Array(7), done: false }
reader.read().then(console.log); // { value: undefined, done: true }

```


### âœ… ä¸ƒã€å‰åç«¯ä½¿ç”¨ Stream çš„åœºæ™¯
1. å‰ç«¯ï¼š1. æ–‡ä»¶ä¸Šä¼  2. è§†é¢‘æµ
2. åç«¯ï¼š1. æ–‡ä»¶ä¸‹è½½ 2. 
3. ç¤ºä¾‹ï¼š
   
```js
// nodejs
const http = require('http');
const fs = require('fs');

http.createServer((req, res) => {
  const readStream = fs.createReadStream('./bigfile.txt');
  readStream.pipe(res); // å®æ—¶ä¼ è¾“æ–‡ä»¶å†…å®¹
}).listen(3000);

// æµè§ˆå™¨  å› ä¸º res.body æ˜¯ ReadableStream å¯¹è±¡ï¼Œè€Œ ReadableStream æ˜¯ Web Streams API çš„æ ¸å¿ƒç±»å‹ï¼Œå®ƒå®šä¹‰äº†è¿™ä¸ªæ–¹æ³•ï¼š
fetch('/api/stream')
    // ReadableStream.prototype.getReader()
  .then(res => res.body.getReader()) //è¿™è¿”å›ä¸€ä¸ª Readerï¼ˆè¯»å–å™¨ï¼‰å¯¹è±¡ï¼Œç±»å‹ä¸ºï¼šReadableStreamDefaultReader<Uint8Array>
  .then(async reader => {
    const decoder = new TextDecoder();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      console.log(decoder.decode(value, { stream: true }));
    }
  });

// TextDecoder(); æ˜¯åœ¨ JavaScript ä¸­åˆ›å»ºä¸€ä¸ªæ–‡æœ¬è§£ç å™¨å¯¹è±¡ï¼Œç”¨äºå°† äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚ Uint8Arrayã€Bufferï¼‰è§£ç ä¸ºå­—ç¬¦ä¸²ã€‚
const bytes = new Uint8Array([72, 101, 108, 108, 111]); // ASCII ç¼–ç : H e l l o
const decoder = new TextDecoder(); // é»˜è®¤ utf-8
const text = decoder.decode(bytes);

console.log(text); // è¾“å‡º: Hello

```
