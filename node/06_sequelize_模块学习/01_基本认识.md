# ğŸ“¦ ä¸€ã€ä»€ä¹ˆæ˜¯ Sequelizeï¼Ÿ


**Sequelize** æ˜¯ä¸€ä¸ª Node.js çš„ **ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰åº“**ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ï¼š

* MySQL / MariaDB
* PostgreSQL
* SQLite
* Microsoft SQL Server

> ä½¿ç”¨ Sequelizeï¼Œä½ å¯ä»¥åƒæ“ä½œ JavaScript å¯¹è±¡ä¸€æ ·æ“ä½œæ•°æ®åº“ã€‚

---

# ğŸ§± äºŒã€ORM åŸç†ç®€è¿°

ORM å°† **è¡¨æ˜ å°„ä¸ºç±»**ï¼Œ**è¡Œæ˜ å°„ä¸ºå®ä¾‹**ï¼Œ**å­—æ®µæ˜ å°„ä¸ºå±æ€§**ã€‚


| æ•°æ®åº“æœ¯è¯­      | ORM æ˜ å°„æœ¯è¯­ |
| ---------- | -------- |
| Table      | Model ç±»  |
| Row        | Model å®ä¾‹ |
| Column     | å±æ€§ï¼ˆå­—æ®µï¼‰   |
| ForeignKey | å…³è”å…³ç³»     |

---

# ğŸš€ ä¸‰ã€å®‰è£…

```bash
npm install sequelize mysql2
```

> å®‰è£… mysql2 æ˜¯å› ä¸º Sequelize æœ¬èº«ä¸å¸¦æ•°æ®åº“é©±åŠ¨ã€‚

---

# âœï¸ å››ã€å¿«é€Ÿä¸Šæ‰‹ç¤ºä¾‹

```js
const { Sequelize, DataTypes } = require('sequelize');

// åˆ›å»ºè¿æ¥
const sequelize = new Sequelize('sequelize_db', 'root', 'root', {
  host: 'localhost',
  dialect: 'mysql'
});

// å®šä¹‰æ¨¡å‹
cosnt User = sequelize.define('User', {
    id: {type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true},
    username: {type: DataTypes.STRING},
    email: {type: DataTypes.STRING}
})

// åŒæ­¥è¡¨ç»“æ„
async function main() {
    await sequelize.sync();
    // åˆ›å»ºå®ä¾‹ æ’å…¥æ•°æ®
    const user = await User.create({username: 'tom', email: 'tom@example.com'});
    console.log(user.toJSON());
}

main();
```
    
---

# ğŸ§° äº”ã€æ ¸å¿ƒæ¨¡å—åŠå¸¸ç”¨æ–¹æ³•

---

## âœ… 1. Sequelize å®ä¾‹ï¼ˆæ•°æ®åº“è¿æ¥ï¼‰

```js
const sequelize = new Sequelize(database, username, password, options)
```

### å¸¸ç”¨å±æ€§ & æ–¹æ³•ï¼š

| æ–¹æ³• / å±æ€§                    | è¯´æ˜       |
| -------------------------- | -------- |
| `sequelize.authenticate()` | æµ‹è¯•æ•°æ®åº“è¿æ¥  |
| `sequelize.sync()`         | åŒæ­¥æ¨¡å‹ï¼ˆå»ºè¡¨ï¼‰ |
| `sequelize.transaction()`  | æ‰§è¡Œäº‹åŠ¡     |
| `sequelize.define()`       | å®šä¹‰æ¨¡å‹     |
| `sequelize.models`         | æ‰€æœ‰æ¨¡å‹é›†åˆ   |

---

## âœ… 2. Modelï¼ˆæ¨¡å‹ç±»ï¼‰

å®šä¹‰è¡¨ç»“æ„ï¼Œå¯¹åº”æ•°æ®åº“è¡¨ã€‚

```js
const User = sequelize.define('User', {
    name: DataTypes.STRING,
    age: DataTypes.INTEGER,
    email: DataTypes.STRING
});
```

### å®ä¾‹æ–¹æ³•ï¼š

| æ–¹æ³•                  | è¯´æ˜     |
| ------------------- | ------ |
| `User.create()`     | åˆ›å»ºè®°å½•   |
| `User.findAll()`    | æŸ¥è¯¢æ‰€æœ‰è®°å½• |
| `User.findOne()`    | æŸ¥è¯¢ä¸€æ¡   |
| `User.findByPk()`   | é€šè¿‡ä¸»é”®æŸ¥è¯¢ |
| `User.update()`     | æ‰¹é‡æ›´æ–°   |
| `User.destroy()`    | æ‰¹é‡åˆ é™¤   |
| `User.count()`      | ç»Ÿè®¡æ•°é‡   |
| `User.bulkCreate()` | æ‰¹é‡æ’å…¥   |

---

### æŸ¥è¯¢æ¡ä»¶è¯­æ³•ï¼š

```js
User.findAll({
    where: {
        age: { [Op.gt]: 18 },
        name: { [Op.like]: '%tom%' }
    },
    limit: 10,
    order: [['createdAt', 'DESC']]
});
```

> Sequelize çš„æŸ¥è¯¢ä½¿ç”¨ **æ“ä½œç¬¦ï¼ˆOpï¼‰**ï¼š               

```js
const { Op } = require('sequelize');

{
  [Op.gt]: 10,       // >
  [Op.gte]: 10,      // >=
  [Op.like]: '%abc%' // æ¨¡ç³ŠåŒ¹é…
}
```


| æ“ä½œç¬¦           | è¯´æ˜        | ç¤ºä¾‹                                             |
| ------------- | --------- | ---------------------------------------------- |
| `Op.eq`       | ç­‰äº        | `{ age: { [Op.eq]: 18 } }`                     |
| `Op.ne`       | ä¸ç­‰äº       | `{ age: { [Op.ne]: 18 } }`                     |
| `Op.gt / gte` | å¤§äº / å¤§äºç­‰äº | `{ age: { [Op.gt]: 20 } }`                     |
| `Op.in`       | åŒ…å«åœ¨æ•°ç»„ä¸­    | `{ id: { [Op.in]: [1, 2, 3] } }`               |
| `Op.or`       | æˆ–å…³ç³»       | `[ { title: {...} }, { description: {...} } ]` |
| `Op.and`      | ä¸å…³ç³»       | `[ { status: 1 }, { deleted: false } ]`        |
| `Op.like`     | æ¨¡ç³ŠåŒ¹é…      | `{ title: { [Op.like]: '%Vue%' } }`            |


---

## âœ… 3. DataTypesï¼ˆæ•°æ®ç±»å‹ï¼‰

| Sequelize ç±»å‹ | å¯¹åº” MySQL ç±»å‹ |
| ------------ | ----------- |
| `STRING`     | VARCHAR     |
| `TEXT`       | TEXT        |
| `INTEGER`    | INT         |
| `BOOLEAN`    | TINYINT(1)  |
| `DATE`       | DATETIME    |
| `FLOAT`      | FLOAT       |
| `DECIMAL`    | DECIMAL     |

---

## âœ… 4. å…³è”å…³ç³»ï¼ˆå…³ç³»å‹æ˜ å°„ï¼‰

### ä¸€å¯¹ä¸€ï¼š

```js

User.hasOne(Profile)
Profile.belongsTo(User)

```

### ä¸€å¯¹å¤šï¼š

```js
User.hasMany(Post)
Post.belongsTo(User)
```

### å¤šå¯¹å¤šï¼š

```js
User.belongsToMany(Role, { through: 'UserRoles' }) // ç”¨æˆ·å’Œè§’è‰²å¤šå¯¹å¤šå…³ç³» UserRoles ä¸­é—´è¡¨
Role.belongsToMany(User, { through: 'UserRoles' });
```

---

# ğŸ“ å…­ã€å®Œæ•´ CRUD ç¤ºä¾‹

```js
// æ·»åŠ 
await User.create({ username: 'tom', email: 't@t.com' })
// æŸ¥è¯¢  
const users = await User.findAll({ where: { usename:'tom'}})

// æ›´æ–°
await User.update({username:'tom'},{where:{id:1}})


// åˆ é™¤
await User.destroy({where:{id:1}})
     
```

---

# ğŸ“ ä¸ƒã€äº‹åŠ¡å¤„ç†

```js

const t = await sequelize.transaction()

try{
    await User.create({ username: 'tom', email: 't@t.com' }, { transaction: t })
    await Profile.create({ userId: 1}, { transaction: t })
    await t.commit()
} catch (error){
    await t.rollback()
}


```

# ğŸŒ å…«ã€ä½¿ç”¨åœºæ™¯

| åœºæ™¯               | ç”¨æ³•                        |
| ---------------- | ------------------------- |
| Web åº”ç”¨æ¥å£å¼€å‘       | åŸºç¡€ CRUDã€åˆ†é¡µã€æŸ¥è¯¢ã€æ’åº          |
| åå°ç®¡ç†ç³»ç»Ÿ           | è¡¨å•æ·»åŠ ä¿®æ”¹ã€åˆ—è¡¨æŸ¥è¯¢               |
| å¤šè¡¨æŸ¥è¯¢å’Œç»Ÿè®¡          | æ¨¡å‹å…³è”ã€èšåˆå‡½æ•°                 |
| é¡¹ç›®ä¸­å¿«é€Ÿå¼€å‘ MVP æ¨¡å‹å±‚  | é€šè¿‡æ¨¡å‹å»ºè¡¨ã€å®šä¹‰ä¸šåŠ¡å®ä½“             |
| API è¿”å› JSON æ ¼å¼æ•°æ® | Sequelize æŸ¥è¯¢è¿”å›çš„å°±æ˜¯ JSON å¯¹è±¡ |




