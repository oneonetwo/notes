# ğŸ¯ ä¹ã€ç»ƒä¹ é¢˜ & å®æˆ˜é¢˜

---

## ğŸ“ åº”ç”¨é¢˜

1. Sequelize çš„ `sync()` å’Œ `sync({ force: true })` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
    - ğŸ“Œ ä½œç”¨ï¼š
        - `sync()`ï¼šç”¨äºæ ¹æ®ä½ å®šä¹‰çš„æ¨¡å‹ç»“æ„ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¯¹åº”çš„æ•°æ®è¡¨
        - æ˜¯ Sequelize çš„ä¸€ç§ã€Œè‡ªåŠ¨å»ºè¡¨/åŒæ­¥æœºåˆ¶ã€

| æ–¹æ³•                                | å«ä¹‰             | ä¼šæ¸…ç©ºåŸè¡¨æ•°æ®ï¼Ÿ | ä½¿ç”¨åœºæ™¯          |
| --------------------------------- | -------------- | -------- | ------------- |
| `sequelize.sync()`                | è‹¥è¡¨ä¸å­˜åœ¨åˆ™åˆ›å»º       | âŒ ä¸ä¼š     | æ­£å¼ç¯å¢ƒã€å®‰å…¨åŒæ­¥     |
| `sequelize.sync({ force: true })` | æ¯æ¬¡å…ˆ**åˆ é™¤åŸè¡¨å†é‡å»º** | âœ… ä¼šæ¸…ç©º    | å¼€å‘è°ƒè¯•é˜¶æ®µï¼Œå¿«é€Ÿä¿®æ”¹ç»“æ„ |




2. `create()` å’Œ `build()` çš„åŒºåˆ«ï¼Ÿ

| æ–¹æ³•         | å«ä¹‰              | ä¼šç«‹å³å†™å…¥æ•°æ®åº“ï¼Ÿ | ä½¿ç”¨åœºæ™¯                  |
| ---------- | --------------- | --------- | --------------------- |
| `build()`  | åˆ›å»ºä¸€ä¸ªæ¨¡å‹å®ä¾‹ï¼ˆåªåœ¨å†…å­˜ä¸­ï¼‰ | âŒ å¦       | éœ€è¦å…ˆä¿®æ”¹å†ä¿å­˜ï¼Œæ¯”å¦‚éªŒè¯é€»è¾‘ã€åŠ å·¥æ•°æ®ç­‰ |
| `create()` | åˆ›å»ºå®ä¾‹å¹¶ç«‹å³ä¿å­˜åˆ°æ•°æ®åº“   | âœ… æ˜¯       | ä¸€æ­¥å®Œæˆæ–°å¢æ•°æ®ï¼ˆæœ€å¸¸ç”¨ï¼‰         |

```js
// buildï¼šå…ˆæ„é€ å¯¹è±¡
const user = User.build({ username: 'alice' });
user.email = 'alice@example.com';
await user.save(); // æ‰‹åŠ¨ä¿å­˜

// createï¼šç›´æ¥æ’å…¥
await User.create({ username: 'bob', email: 'bob@example.com' });

```


3. å¦‚ä½•å®šä¹‰æ¨¡å‹å­—æ®µä¸ºå”¯ä¸€ç´¢å¼•ï¼Ÿå¦‚ä½•è®¾ç½®é»˜è®¤å€¼ï¼Ÿ
```js
const User = sequelize.define('User', {
    username: {
        type: DataTypes.STRING,
        unique: true,
        allowNull: false
    },
    status: {
        type: DataTypes.ENUM('active', 'inactive'),
        defaultValue: 'active'
    },
    create_at: {
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW 
    }
})



```

4. å¦‚ä½•ä½¿ç”¨ Sequelize å®ç°åˆ†é¡µæŸ¥è¯¢ï¼Ÿ
```js
cosnt page = 2
const pageSize = 10
const {count, rows: users} = await User.findAndCountAll({
    offset: (page - 1) * pageSize,
    limit: pageSize,
    order: [['createdAt', 'DESC']]
})



```

---

## ğŸ§ª å®æˆ˜é¢˜

---

### âœ… é¢˜ç›® 1ï¼šå®šä¹‰ç”¨æˆ·è¡¨æ¨¡å‹ `User`

å­—æ®µåŒ…æ‹¬ï¼š

| å­—æ®µ       | ç±»å‹      | é™åˆ¶     |
| -------- | ------- | ------ |
| id       | INTEGER | ä¸»é”®ã€è‡ªå¢  |
| username | STRING  | å”¯ä¸€ã€éç©º  |
| email    | STRING  | å¯ç©º     |
| age      | INTEGER | é»˜è®¤å€¼ 18 |

---

```js
const User = sequelize.define('User', {
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    username: {
        type: DataTypes.STRING,
        unique: true,
        allowNull: false
    },
    email: {
        type: DataTypes: STRING,
        allowNull: true
    },
    age: {
        type: DataTypes.INTEGER,
        defaultValue: 18
    }
})

const Post = sequelize.define('Post', {
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    title: DataTypes.STRING,
    content: DataTypes.TEXT,

})

```

### âœ… é¢˜ç›® 2ï¼šå®ç°ç”¨æˆ· CRUD æ“ä½œ

```js
createUser({ username, email })
getUserById(id)
updateUser(id, newData)
deleteUser(id)

const createUser = async ({username, email}) => {
    const user = await User.create({username, email})
    return user
}
const getUserById = async (id) => {
    const user = await User.findByPk(id)
    return user
}
const updateUser = async (id, newData) => {
    const user = await User.findByPk(id)
    if(!user) {
        return null
    }
    return await user.update(newData)
}
const deleteUser = async (id) => {
    const user = await User.findByPk(id)
    if(!user) {
        return null
    }
    await user.destroy()
    return true
}

```


---

### âœ… é¢˜ç›® 3ï¼šå®ç°åˆ†é¡µå’Œæ¨¡ç³ŠæŸ¥è¯¢
    åŠŸèƒ½ï¼šåˆ†é¡µè¿”å›ç”¨æˆ·åˆ—è¡¨ï¼Œå¯æ ¹æ® `username` æ¨¡ç³Šæœç´¢ã€‚

```js
getUsersByPage(page, pageSize, keyword)

const getUserByPage = async (page = 1, pageSize = 10, keyword) {
    const offset = (page - 1) * pageSize
    return await Post.findAndCountAll({
        where: keyword ? {
            username: {
                [Op.like]: `%${keyword}%`
            }
        },
        offset,
        limit: pageSize
    })
}

```


---

### âœ… é¢˜ç›® 4ï¼šå®šä¹‰ `User` å’Œ `Post` çš„ä¸€å¯¹å¤šå…³ç³»

* ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªå¸–å­
* æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰å¸–å­
* æŸ¥è¯¢æŸç¯‡å¸–å­æ‰€å±ç”¨æˆ·

```js
User.hasMany(Post)
Post.belongsTo(User)
// æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰å¸–å­
const getPostsByUser = async (userId) => {
    const user = await User.findByPk(userId, {
        include: [{
            model: Post,
            as: 'posts'
        }]
    })
    return user ? user.posts : null
}

// æŸ¥è¯¢æŸç¯‡å¸–å­æ‰€å±ç”¨æˆ·
const getUserByPost = async (postId) => {
    const post = await Post.findByPk(postId, {
        include: [{
            model: User,
            as: 'user'
        }]
    })
    return post ? post.user : null
}

```
---

### âœ… é¢˜ç›® 5ï¼šæ„å»ºäº‹åŠ¡å¤„ç†

* ç”¨æˆ·æ³¨å†Œæ—¶åŒæ—¶åˆ›å»ºç”¨æˆ·ä¿¡æ¯å’Œå…¶é»˜è®¤é…ç½®
* ä»»æ„æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªå›æ»š

```js
const registerUser = sequelize.transaction(async (t) => {
    const user = await User.create({
        username,
        email
    }, {transaction: t})
    
})
const registerUserWithDefaultConfig = async () => {
    const t = await sequelize.transaction()
    try {
        const user = await User.create({ username, email }, { transaction: t })
        await Post.create({title: 'æ¬¢è¿è´´', content: 'æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„ç¤¾åŒº', userId: user.id}, { transaction: t })
        await t.commit()
        return user
    } catch (error) {
        await t.rollback()
        throw error
    }
}

```

---

# ğŸ“˜ åã€æ¨èå­¦ä¹ èµ„æº

* å®˜æ–¹æ–‡æ¡£ï¼š[https://sequelize.org](https://sequelize.org)
* ä¸­æ–‡æ–‡æ¡£ï¼ˆç¤¾åŒºç»´æŠ¤ï¼‰ï¼š[https://sequelize.cn](https://sequelize.cn)
* GitHub ç¤ºä¾‹é¡¹ç›®ï¼š[https://github.com/sequelize/express-example](https://github.com/sequelize/express-example)
* TypeORMï¼ˆå¦ä¸€ä¸ªæµè¡Œ ORMï¼‰å¯¹æ¯”å‚è€ƒï¼š[https://typeorm.io](https://typeorm.io)

---

æ˜¯å¦éœ€è¦æˆ‘ä¸ºä½ å®ç°ä¸Šé¢çš„æŸä¸€é¢˜å®Œæ•´ä»£ç ç¤ºä¾‹ï¼Ÿæˆ–è€…ç»“åˆ Expressã€JWTã€Sequelize æ„å»ºä¸€æ•´å¥— RESTful API ç™»å½•ç³»ç»Ÿï¼Ÿæ¬¢è¿ç»§ç»­æé—®ï¼Œæˆ‘å¯ä»¥æ‰‹æŠŠæ‰‹å¸¦ä½ åšå®Œæ•´é¡¹ç›®ã€‚
